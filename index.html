<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Geovisor de Poblados</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <style>
    * { box-sizing: border-box; }
    
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #64748b;
      --accent: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --surface: #ffffff;
      --surface-2: #f8fafc;
      --surface-3: #f1f5f9;
      --text: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      margin: 0; 
      padding: 0; 
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--surface-2);
      color: var(--text);
    }
    
    .header {
      background: var(--gradient);
      color: white;
      padding: 1rem 1.5rem;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }
    
    .header-content {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .stats-quick {
      display: flex;
      gap: 1.5rem;
      font-size: 0.85rem;
    }
    
    .stat-quick {
      text-align: center;
    }
    
    .stat-quick-number {
      font-size: 1.25rem;
      font-weight: 700;
      display: block;
    }
    
    .controls {
      background: var(--surface);
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .control-group label {
      font-weight: 600;
      color: var(--text);
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    select, input {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.85rem;
      transition: all 0.2s;
      background: var(--surface);
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    
    .controls-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      text-decoration: none;
    }
    
    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: var(--secondary);
    }
    
    .btn-secondary:hover {
      background: #475569;
    }
    
    .btn-success {
      background: var(--success);
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .main-content {
      flex: 1;
      display: flex;
      min-height: 0;
      gap: 0.75rem;
      padding: 0.75rem;
    }
    
    .map-container {
      flex: 1;
      background: var(--surface);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      position: relative;
    }
    
    #map {
      width: 100%;
      height: 100%;
      min-height: 500px;
    }

    /* Notificaciones del mapa */
    .map-notifications {
      position: absolute;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      pointer-events: none;
      width: 100%;
      max-width: 400px;
      padding: 0 1rem;
    }

    .map-notification {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-left: 4px solid transparent;
      animation: slideInFromTop 0.3s ease-out;
      max-width: 100%;
      word-wrap: break-word;
    }

    @keyframes slideInFromTop {
      from { 
        opacity: 0; 
        transform: translateY(-20px) scale(0.95); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
    }

    @keyframes slideOutToTop {
      from { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
      to { 
        opacity: 0; 
        transform: translateY(-20px) scale(0.95); 
      }
    }

    .map-notification.success {
      border-left-color: var(--success);
      color: #065f46;
    }

    .map-notification.error {
      border-left-color: var(--error);
      color: #991b1b;
    }

    .map-notification.loading {
      border-left-color: var(--accent);
      color: #155e75;
    }

    .map-notification.removing {
      animation: slideOutToTop 0.2s ease-in forwards;
    }
    
    .map-overlay {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .map-control {
      background: var(--surface);
      border: none;
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: all 0.15s;
      font-size: 0.8rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .map-control:hover {
      background: var(--surface-2);
      transform: scale(1.05);
    }
    
    .sidebar {
      width: 320px;
      background: var(--surface);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-header {
      padding: 1rem;
      background: var(--surface-2);
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .stats-grid {
      padding: 1rem;
      background: var(--surface);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    
    .stat-card {
      text-align: center;
      padding: 0.75rem;
      background: var(--surface-2);
      border-radius: 6px;
      border: 1px solid var(--border);
      transition: all 0.15s;
    }
    
    .stat-card:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    
    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      display: block;
    }
    
    .stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }
    
    .poblado-list {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }
    
    .poblado-item {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
    }
    
    .poblado-item:hover {
      background: var(--surface-2);
    }
    
    .poblado-item.selected {
      background: rgba(37, 99, 235, 0.1);
      border-left: 3px solid var(--primary);
    }
    
    .poblado-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .poblado-info {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.4;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.25rem;
    }
    
    .poblado-tag {
      display: inline-block;
      background: var(--primary);
      color: white;
      padding: 0.125rem 0.375rem;
      border-radius: 3px;
      font-size: 0.65rem;
      font-weight: 600;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
    
    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .distance-info {
      font-size: 0.7rem;
      color: var(--accent);
      font-weight: 600;
    }

    /* Custom cluster styles */
    .marker-cluster-small {
      background-color: rgba(37, 99, 235, 0.6);
    }
    .marker-cluster-small div {
      background-color: rgba(37, 99, 235, 0.8);
    }
    .marker-cluster-medium {
      background-color: rgba(16, 185, 129, 0.6);
    }
    .marker-cluster-medium div {
      background-color: rgba(16, 185, 129, 0.8);
    }
    .marker-cluster-large {
      background-color: rgba(245, 158, 11, 0.6);
    }
    .marker-cluster-large div {
      background-color: rgba(245, 158, 11, 0.8);
    }

    /* Custom marker styles */
    .custom-marker {
      background: none !important;
      border: none !important;
    }

    .marker-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: bold;
      color: white;
    }

    .marker-ciudad { background: #2563eb; }
    .marker-pueblo { background: #10b981; }
    .marker-villa { background: #f59e0b; }
    .marker-aldea { background: #ef4444; }
    .marker-default { background: #64748b; }

    @media (max-width: 1024px) {
      .main-content {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: 300px;
      }
      .controls-grid {
        grid-template-columns: 1fr 1fr;
      }
      .stats-quick {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .header {
        padding: 0.75rem 1rem;
      }
      .header h1 {
        font-size: 1.25rem;
      }
      .controls {
        padding: 0.75rem;
      }
      .controls-grid {
        grid-template-columns: 1fr;
      }
      .main-content {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-content">
      <h1>
        🗺️ Geovisor de Poblados
      </h1>
      <div class="stats-quick">
        <div class="stat-quick">
          <span class="stat-quick-number" id="headerTotal">0</span>
          <span>Total</span>
        </div>
        <div class="stat-quick">
          <span class="stat-quick-number" id="headerVisible">0</span>
          <span>Visibles</span>
        </div>
        <div class="stat-quick">
          <span class="stat-quick-number" id="headerProvincias">0</span>
          <span>Provincias</span>
        </div>
      </div>
    </div>
  </div>

  <div class="controls">
    <div class="controls-grid">
      <div class="control-group">
        <label>📍 Provincia</label>
        <select id="provinciaFilter">
          <option value="">Todas las provincias</option>
        </select>
      </div>
      
      <div class="control-group">
        <label>🏢 Tipo</label>
        <select id="tipoFilter">
          <option value="">Todos los tipos</option>
        </select>
      </div>
      
      <div class="control-group">
        <label>🔍 Buscar</label>
        <input type="text" id="searchInput" placeholder="Nombre del poblado..." />
      </div>

      <div class="control-group">
        <label>📏 Radio (km)</label>
        <input type="number" id="radiusInput" placeholder="Radio en km" min="1" max="500" />
      </div>
    </div>
    
    <div class="controls-actions">
      <button class="btn" onclick="aplicarFiltros()">
        🔎 Filtrar
      </button>
      <button class="btn btn-secondary" onclick="limpiarFiltros()">
        ❌ Limpiar
      </button>
      <button class="btn btn-success" onclick="buscarCercanos()">
        📍 Cercanos
      </button>
      <button class="btn btn-secondary" onclick="obtenerUbicacion()">
        🎯 Mi Ubicación
      </button>
    </div>
  </div>

  <div class="main-content">
    <div class="map-container">
      <div id="map"></div>
      
      <!-- Notificaciones flotantes dentro del mapa -->
      <div id="mapNotifications" class="map-notifications"></div>
      
      <div class="map-overlay">
        <button class="map-control" onclick="fitAllMarkers()" title="Ver todos">
          ⤢
        </button>
        <button class="map-control" onclick="buscarMasCercano()" title="Más cercano">
          🎯
        </button>
      </div>
    </div>
    
    <div class="sidebar">
      <div class="sidebar-header">
        📋 Poblados Encontrados
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-number" id="totalCount">0</span>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="visibleCount">0</span>
          <div class="stat-label">Visibles</div>
        </div>
      </div>
      
      <div class="poblado-list" id="pobladoList">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div>Cargando poblados...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts optimizados -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script>
    // Configuración de Supabase
    const SUPABASE_URL = 'https://sbkmybydshshxoiiimve.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNia215Ynlkc2hzaHhvaWlpbXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyOTMwODIsImV4cCI6MjA2NTg2OTA4Mn0.ZsXSKy3pYGA9AA9oXJLzPkdEhryieF-5Z3XSREueEfc';

    // Inicializar cliente de Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Variables globales
    let map;
    let markersCluster;
    let poblados = [];
    let filteredPoblados = [];
    let selectedPoblado = null;
    let userLocation = null;
    let currentMode = 'all';

    // Cache para mejorar performance
    const markerCache = new Map();

    // Inicializar la aplicación
    window.addEventListener('DOMContentLoaded', async () => {
      initMap();
      await cargarDatosIniciales();
      configurarEventos();
    });

    function initMap() {
      // Centrar en Ecuador
      map = L.map('map', {
        center: [-1.8312, -78.1834],
        zoom: 6,
        zoomControl: false,
        preferCanvas: true // Mejor performance para muchos marcadores
      });
      
      // Agregar control de zoom en posición personalizada
      L.control.zoom({
        position: 'bottomright'
      }).addTo(map);
      
      // Usar OpenStreetMap estándar (más rápido y ligero)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 18,
        tileSize: 256,
        updateWhenZooming: false, // Mejora performance
        updateWhenIdle: true
      }).addTo(map);
      
      // Crear cluster de marcadores con configuración optimizada
      markersCluster = L.markerClusterGroup({
        chunkedLoading: true,
        chunkDelay: 50,
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        removeOutsideVisibleBounds: true, // Mejora performance
        animate: true,
        animateAddingMarkers: false // Mejora performance inicial
      });
      
      map.addLayer(markersCluster);

      // Eventos del mapa
      map.on('click', onMapClick);
    }

    async function cargarDatosIniciales() {
      await Promise.all([
        cargarPoblados(),
        cargarProvincias(),
        cargarTipos(),
        cargarEstadisticas()
      ]);
    }

    async function cargarPoblados() {
      // Limpiar cualquier notificación anterior
      const container = document.getElementById('mapNotifications');
      container.innerHTML = '';
      
      const loadingNotification = mostrarNotificacionMapa('loading', 'Cargando poblados...');

      try {
        const { data, error } = await supabase.rpc('get_all_poblados');

        if (error) throw error;

        poblados = data || [];
        filteredPoblados = [...poblados];
        
        // Remover notificación de carga antes de mostrar éxito
        removerNotificacionMapa(loadingNotification);
        mostrarNotificacionMapa('success', `${poblados.length} poblados cargados`, 2000);
        
        mostrarPobladosEnMapa();
        actualizarListaPoblados();
        actualizarEstadisticas();
        
      } catch (error) {
        console.error('Error:', error);
        removerNotificacionMapa(loadingNotification);
        mostrarNotificacionMapa('error', `Error: ${error.message}`);
        await cargarPobladosFallback();
      }
    }

    async function cargarPobladosFallback() {
      const loadingNotification = mostrarNotificacionMapa('loading', 'Carga alternativa...');

      try {
        const { data, error } = await supabase
          .from('poblados')
          .select('*');

        if (error) throw error;

        poblados = data.map(poblado => ({
          ...poblado,
          geom_geojson: poblado.geom
        }));
        
        filteredPoblados = [...poblados];
        
        removerNotificacionMapa(loadingNotification);
        mostrarNotificacionMapa('success', `${poblados.length} poblados (modo compatibilidad)`, 2500);
        
        mostrarPobladosEnMapa();
        actualizarListaPoblados();
        actualizarEstadisticas();
        
      } catch (error) {
        removerNotificacionMapa(loadingNotification);
        mostrarNotificacionMapa('error', `Error: ${error.message}`);
      }
    }

    async function cargarProvincias() {
      try {
        const { data, error } = await supabase.rpc('get_unique_provincias');
        if (!error && data) {
          const select = document.getElementById('provinciaFilter');
          select.innerHTML = '<option value="">Todas las provincias</option>' +
            data.map(p => `<option value="${p.provincia}">${p.provincia}</option>`).join('');
        }
      } catch (error) {
        console.error('Error provincias:', error);
      }
    }

    async function cargarTipos() {
      try {
        const { data, error } = await supabase.rpc('get_unique_tipos');
        if (!error && data) {
          const select = document.getElementById('tipoFilter');
          select.innerHTML = '<option value="">Todos los tipos</option>' +
            data.map(t => `<option value="${t.tipo}">${t.tipo}</option>`).join('');
        }
      } catch (error) {
        console.error('Error tipos:', error);
      }
    }

    async function cargarEstadisticas() {
      try {
        const { data, error } = await supabase.rpc('get_poblados_stats');
        if (!error && data && data.length > 0) {
          const stats = data[0];
          document.getElementById('headerTotal').textContent = stats.total_poblados;
          document.getElementById('headerProvincias').textContent = stats.total_provincias;
        }
      } catch (error) {
        console.error('Error estadísticas:', error);
      }
    }

    function mostrarPobladosEnMapa() {
      // Limpiar cluster
      markersCluster.clearLayers();
      markerCache.clear();
      
      // Procesar en lotes para mejor performance
      const batchSize = 100;
      let batchIndex = 0;
      
      function processBatch() {
        const start = batchIndex * batchSize;
        const end = Math.min(start + batchSize, filteredPoblados.length);
        
        for (let i = start; i < end; i++) {
          const poblado = filteredPoblados[i];
          const geom = poblado.geom_geojson || poblado.geom;
          
          if (geom && geom.coordinates) {
            const [lng, lat] = geom.coordinates;
            const marker = createOptimizedMarker(poblado, lat, lng);
            markersCluster.addLayer(marker);
          }
        }
        
        batchIndex++;
        
        if (end < filteredPoblados.length) {
          requestAnimationFrame(processBatch);
        }
      }
      
      processBatch();
      llenarFiltrosFallback();
    }

    function createOptimizedMarker(poblado, lat, lng) {
      const cacheKey = `${poblado.gid}_${lat}_${lng}`;
      
      if (markerCache.has(cacheKey)) {
        return markerCache.get(cacheKey);
      }
      
      const tipo = poblado.tipo?.toLowerCase() || 'default';
      const icon = L.divIcon({
        html: `<div class="marker-icon marker-${tipo}">${getIconEmoji(tipo)}</div>`,
        className: 'custom-marker',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
      
      const marker = L.marker([lat, lng], { icon })
        .bindPopup(() => createPopupContent(poblado), {
          maxWidth: 250,
          className: 'custom-popup'
        });
        
      // Almacenar referencia del poblado en el marcador
      marker.poblado = poblado;
      
      // Evento de clic en el marcador
      marker.on('click', () => {
        selectPobladoFromMap(poblado);
      });
      
      markerCache.set(cacheKey, marker);
      return marker;
    }

    function selectPobladoFromMap(poblado) {
      selectedPoblado = poblado;
      
      // Actualizar selección visual en la lista
      document.querySelectorAll('.poblado-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      const selectedItem = Array.from(document.querySelectorAll('.poblado-item'))
        .find(item => item.textContent.includes(poblado.nombre));
      if (selectedItem) {
        selectedItem.classList.add('selected');
        selectedItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
      mostrarNotificacionMapa('success', `📍 ${poblado.nombre}`, 2000);
    }

    function getIconEmoji(tipo) {
      const icons = {
        'ciudad': '🏙',
        'pueblo': '🏘',
        'villa': '🏡',
        'aldea': '🏠',
        'default': '📍'
      };
      return icons[tipo] || icons.default;
    }

    function createPopupContent(poblado) {
      let distanceText = '';
      if (poblado.distance_meters !== undefined) {
        const distanceKm = (poblado.distance_meters / 1000).toFixed(1);
        distanceText = `<div class="distance-info">📏 ${distanceKm} km</div>`;
      }

      return `
        <div style="min-width: 200px; font-family: system-ui, sans-serif;">
          <h3 style="margin: 0 0 8px 0; color: #1e293b; font-size: 1rem; display: flex; align-items: center; gap: 4px;">
            ${getIconEmoji(poblado.tipo?.toLowerCase())} ${poblado.nombre}
          </h3>
          ${distanceText}
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 0.8rem;">
            <div><strong>Código:</strong> ${poblado.f_code || 'N/A'}</div>
            <div><strong>Provincia:</strong> ${poblado.provincia || 'N/A'}</div>
            <div><strong>Tipo:</strong> ${poblado.tipo || 'N/A'}</div>
            <div><strong>SOC:</strong> ${poblado.soc || 'N/A'}</div>
          </div>
        </div>
      `;
    }

    function actualizarListaPoblados() {
      const lista = document.getElementById('pobladoList');
      
      if (filteredPoblados.length === 0) {
        lista.innerHTML = `
          <div class="loading">
            🔍
            <div>No se encontraron poblados</div>
          </div>
        `;
        return;
      }
      
      // Limitar la lista para mejor performance
      const maxItems = 100;
      const itemsToShow = filteredPoblados.slice(0, maxItems);
      
      lista.innerHTML = itemsToShow.map((poblado, index) => {
        let distanceText = '';
        if (poblado.distance_meters !== undefined) {
          const distanceKm = (poblado.distance_meters / 1000).toFixed(1);
          distanceText = `<div class="distance-info">📏 ${distanceKm} km</div>`;
        }

        // Usar un identificador simple y seguro
        return `
          <div class="poblado-item" onclick="selectPobladoFromList('${poblado.gid || index}', '${poblado.nombre}', ${poblado.geom_geojson?.coordinates?.[1] || 'null'}, ${poblado.geom_geojson?.coordinates?.[0] || 'null'})">
            <div class="poblado-name">
              ${getIconEmoji(poblado.tipo?.toLowerCase())} ${poblado.nombre}
              <span class="poblado-tag">${poblado.tipo || 'N/A'}</span>
            </div>
            <div class="poblado-info">
              <div><strong>Provincia:</strong> ${poblado.provincia || 'N/A'}</div>
              <div><strong>Código:</strong> ${poblado.f_code || 'N/A'}</div>
              <div><strong>SOC:</strong> ${poblado.soc || 'N/A'}</div>
              ${distanceText}
            </div>
          </div>
        `;
      }).join('');
      
      if (filteredPoblados.length > maxItems) {
        lista.innerHTML += `
          <div style="padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.8rem;">
            Mostrando ${maxItems} de ${filteredPoblados.length} poblados
          </div>
        `;
      }
    }

    // Nueva función simplificada para selección desde la lista
    function selectPobladoFromList(gid, nombre, lat, lng) {
      console.log('Seleccionando poblado:', { gid, nombre, lat, lng });
      
      // Buscar el poblado completo en el array
      const poblado = filteredPoblados.find(p => 
        (p.gid && p.gid == gid) || 
        p.nombre === nombre
      );
      
      if (!poblado) {
        console.error('Poblado no encontrado:', nombre);
        mostrarNotificacionMapa('error', 'No se pudo encontrar el poblado');
        return;
      }
      
      selectedPoblado = poblado;
      
      // Actualizar selección visual en la lista
      document.querySelectorAll('.poblado-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      const selectedItem = Array.from(document.querySelectorAll('.poblado-item'))
        .find(item => item.textContent.includes(nombre));
      if (selectedItem) {
        selectedItem.classList.add('selected');
      }
      
      // Verificar coordenadas
      if (!lat || !lng || lat === 'null' || lng === 'null') {
        console.error('Coordenadas inválidas:', { lat, lng });
        mostrarNotificacionMapa('error', 'Coordenadas no disponibles');
        return;
      }
      
      const targetLat = parseFloat(lat);
      const targetLng = parseFloat(lng);
      
      // Mostrar notificación de carga
      const loadingNotification = mostrarNotificacionMapa('loading', `Ubicando ${nombre}...`);
      
      console.log('Buscando marcador en coordenadas:', { targetLat, targetLng });
      
      // Buscar el marcador en el cluster con mejor algoritmo
      const targetMarker = findMarkerInClusterImproved(gid, targetLat, targetLng, nombre);
      
      if (targetMarker) {
        console.log('Marcador encontrado, expandiendo cluster...');
        
        // Usar el método más confiable del cluster
        markersCluster.zoomToShowLayer(targetMarker, (completedCallback) => {
          console.log('Zoom completado, abriendo popup...');
          
          // Remover notificación de carga
          removerNotificacionMapa(loadingNotification);
          
          // Pequeño delay para asegurar que el zoom se complete
          setTimeout(() => {
            targetMarker.openPopup();
            highlightMarker(targetMarker);
            mostrarNotificacionMapa('success', `📍 ${nombre}`, 2000);
          }, 100);
        });
        
      } else {
        console.log('Marcador no encontrado, usando fallback...');
        
        // Remover notificación de carga
        removerNotificacionMapa(loadingNotification);
        
        // Fallback: centrar manualmente y crear highlight
        map.setView([targetLat, targetLng], 12);
        
        // Crear un highlight manual en las coordenadas
        const fallbackHighlight = L.circleMarker([targetLat, targetLng], {
          radius: 15,
          fillColor: '#ef4444',
          fillOpacity: 0.6,
          color: '#ef4444',
          weight: 3,
          opacity: 1
        }).addTo(map).bindPopup(`📍 ${nombre}`).openPopup();
        
        // Remover después de 5 segundos
        setTimeout(() => {
          map.removeLayer(fallbackHighlight);
        }, 5000);
        
        mostrarNotificacionMapa('info', `📍 ${nombre} (ubicación aproximada)`, 2500);
      }
    }

    function findMarkerInClusterImproved(gid, targetLat, targetLng, nombre) {
      console.log('Buscando marcador con criterios:', { gid, targetLat, targetLng, nombre });
      
      let foundMarker = null;
      let allMarkers = [];
      
      // Recopilar todos los marcadores del cluster
      markersCluster.eachLayer(layer => {
        if (layer.poblado) {
          allMarkers.push(layer);
        }
      });
      
      console.log('Total marcadores en cluster:', allMarkers.length);
      
      // Búsqueda por múltiples criterios
      for (let marker of allMarkers) {
        const poblado = marker.poblado;
        const latLng = marker.getLatLng();
        
        // Criterio 1: Por GID exacto
        if (gid && poblado.gid && poblado.gid == gid) {
          console.log('Encontrado por GID:', gid);
          foundMarker = marker;
          break;
        }
        
        // Criterio 2: Por nombre exacto
        if (poblado.nombre === nombre) {
          console.log('Encontrado por nombre:', nombre);
          foundMarker = marker;
          break;
        }
        
        // Criterio 3: Por coordenadas con tolerancia amplia
        const tolerance = 0.001; // Tolerancia más amplia
        if (Math.abs(latLng.lat - targetLat) < tolerance && 
            Math.abs(latLng.lng - targetLng) < tolerance) {
          console.log('Encontrado por coordenadas:', { lat: latLng.lat, lng: latLng.lng });
          foundMarker = marker;
          break;
        }
      }
      
      if (!foundMarker) {
        console.log('Marcador no encontrado con ningún criterio');
        console.log('Marcadores disponibles:', allMarkers.map(m => ({
          nombre: m.poblado?.nombre,
          gid: m.poblado?.gid,
          coords: m.getLatLng()
        })));
      }
      
      return foundMarker;
    }

    function selectPoblado(poblado) {
      if (typeof poblado === 'string') {
        poblado = JSON.parse(decodeURIComponent(poblado));
      }
      
      selectedPoblado = poblado;
      
      // Actualizar selección visual en la lista
      document.querySelectorAll('.poblado-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      const selectedItem = Array.from(document.querySelectorAll('.poblado-item'))
        .find(item => item.textContent.includes(poblado.nombre));
      if (selectedItem) {
        selectedItem.classList.add('selected');
        selectedItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
      // Buscar y mostrar en el mapa
      const geom = poblado.geom_geojson || poblado.geom;
      if (geom && geom.coordinates) {
        const [lng, lat] = geom.coordinates;
        
        // Buscar el marcador específico en el cluster
        const targetMarker = findMarkerInClusterImproved(poblado.gid, lat, lng, poblado.nombre);
        
        if (targetMarker) {
          // Si está en un cluster, expandirlo y hacer zoom
          markersCluster.zoomToShowLayer(targetMarker, () => {
            // Abrir popup después del zoom
            setTimeout(() => {
              targetMarker.openPopup();
              
              // Highlighting temporal del marcador
              highlightMarker(targetMarker);
            }, 300);
          });
        } else {
          // Fallback: centrar en las coordenadas
          map.setView([lat, lng], 14);
        }
        
        mostrarNotificacionMapa('success', `📍 ${poblado.nombre}`, 2000);
      }
    }

    function highlightMarker(marker) {
      // Crear un círculo temporal para highlighting
      const latLng = marker.getLatLng();
      const highlightCircle = L.circleMarker(latLng, {
        radius: 20,
        fillColor: '#f59e0b',
        fillOpacity: 0.4,
        color: '#f59e0b',
        weight: 3,
        opacity: 0.9
      }).addTo(map);
      
      // Animar el círculo con pulsaciones más visibles
      let scale = 1;
      let pulseCount = 0;
      const maxPulses = 6;
      
      const pulseInterval = setInterval(() => {
        scale = scale === 1 ? 1.8 : 1;
        const opacity = scale === 1 ? 0.9 : 0.5;
        
        highlightCircle.setRadius(20 * scale);
        highlightCircle.setStyle({ 
          fillOpacity: opacity * 0.4,
          opacity: opacity 
        });
        
        pulseCount++;
        
        if (pulseCount >= maxPulses) {
          clearInterval(pulseInterval);
          // Fade out final
          setTimeout(() => {
            if (map.hasLayer(highlightCircle)) {
              map.removeLayer(highlightCircle);
            }
          }, 500);
        }
      }, 400);
    }

    async function aplicarFiltros() {
      const provincia = document.getElementById('provinciaFilter').value;
      const tipo = document.getElementById('tipoFilter').value;
      const busqueda = document.getElementById('searchInput').value;

      if (!provincia && !tipo && !busqueda) {
        filteredPoblados = [...poblados];
        currentMode = 'all';
      } else {
        currentMode = 'filtered';
        const loadingNotification = mostrarNotificacionMapa('loading', 'Aplicando filtros...');

        try {
          const { data, error } = await supabase.rpc('search_poblados_advanced', {
            search_name: busqueda || null,
            filter_provincia: provincia || null,
            filter_tipo: tipo || null
          });

          if (error) throw error;

          filteredPoblados = data || [];
          removerNotificacionMapa(loadingNotification);
          mostrarNotificacionMapa('success', `${filteredPoblados.length} poblados encontrados`, 2000);
          
        } catch (error) {
          // Fallback: filtrado local
          filteredPoblados = poblados.filter(poblado => {
            const matchProvincia = !provincia || poblado.provincia === provincia;
            const matchTipo = !tipo || poblado.tipo === tipo;
            const matchBusqueda = !busqueda || poblado.nombre.toLowerCase().includes(busqueda.toLowerCase());
            
            return matchProvincia && matchTipo && matchBusqueda;
          });
          removerNotificacionMapa(loadingNotification);
          mostrarNotificacionMapa('success', `${filteredPoblados.length} poblados (filtrado local)`, 2000);
        }
      }

      mostrarPobladosEnMapa();
      actualizarListaPoblados();
      actualizarEstadisticas();
    }

    function limpiarFiltros() {
      document.getElementById('provinciaFilter').value = '';
      document.getElementById('tipoFilter').value = '';
      document.getElementById('searchInput').value = '';
      document.getElementById('radiusInput').value = '';
      userLocation = null;
      currentMode = 'all';
      
      // Limpiar marcadores adicionales
      if (window.userMarker) {
        map.removeLayer(window.userMarker);
        window.userMarker = null;
      }
      if (window.radiusCircle) {
        map.removeLayer(window.radiusCircle);
        window.radiusCircle = null;
      }
      
      aplicarFiltros();
    }

    async function buscarCercanos() {
      const radius = document.getElementById('radiusInput').value;
      
      if (!userLocation) {
        mostrarNotificacionMapa('error', 'Primero obtén tu ubicación o haz clic en el mapa');
        return;
      }
      
      if (!radius || radius <= 0) {
        mostrarNotificacionMapa('error', 'Ingresa un radio válido en km');
        return;
      }

      currentMode = 'radius';
      const loadingNotification = mostrarNotificacionMapa('loading', `Buscando en ${radius} km...`);

      try {
        const { data, error } = await supabase.rpc('get_poblados_within_radius', {
          center_lat: userLocation.lat,
          center_lon: userLocation.lng,
          radius_meters: radius * 1000
        });

        if (error) throw error;

        filteredPoblados = data || [];
        removerNotificacionMapa(loadingNotification);
        mostrarNotificacionMapa('success', `${filteredPoblados.length} poblados en ${radius} km`, 2500);
        
        mostrarPobladosEnMapa();
        actualizarListaPoblados();
        actualizarEstadisticas();
        
        // Agregar círculo de radio
        if (window.radiusCircle) {
          map.removeLayer(window.radiusCircle);
        }
        window.radiusCircle = L.circle([userLocation.lat, userLocation.lng], {
          radius: radius * 1000,
          fillColor: '#2563eb',
          fillOpacity: 0.1,
          color: '#2563eb',
          weight: 2,
          dashArray: '5, 5'
        }).addTo(map);
        
        // Ajustar vista
        const bounds = window.radiusCircle.getBounds();
        map.fitBounds(bounds, { padding: [20, 20] });
        
      } catch (error) {
        removerNotificacionMapa(loadingNotification);
        mostrarNotificacionMapa('error', `Error: ${error.message}`);
      }
    }

    async function buscarMasCercano() {
      if (!userLocation) {
        mostrarNotificacionMapa('error', 'Primero obtén tu ubicación');
        return;
      }

      const loadingNotification = mostrarNotificacionMapa('loading', 'Buscando más cercano...');

      try {
        const { data, error } = await supabase.rpc('get_nearest_poblado', {
          lat: userLocation.lat,
          lon: userLocation.lng
        });

        if (error) throw error;

        removerNotificacionMapa(loadingNotification);

        if (data && data.length > 0) {
          const poblado = data[0];
          selectPoblado(poblado);
          
          const distanceKm = (poblado.distance_meters / 1000).toFixed(1);
          mostrarNotificacionMapa('success', `Más cercano: ${poblado.nombre} (${distanceKm} km)`, 3000);
        } else {
          mostrarNotificacionMapa('error', 'No se encontró poblado cercano');
        }
        
      } catch (error) {
        removerNotificacionMapa(loadingNotification);
        mostrarNotificacionMapa('error', `Error: ${error.message}`);
      }
    }

    function obtenerUbicacion() {
      if (!navigator.geolocation) {
        mostrarNotificacionMapa('error', 'Geolocalización no soportada');
        return;
      }

      const loadingNotification = mostrarNotificacionMapa('loading', 'Obteniendo ubicación...');

      navigator.geolocation.getCurrentPosition(
        (position) => {
          userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          
          removerNotificacionMapa(loadingNotification);
          mostrarNotificacionMapa('success', 'Ubicación obtenida', 2000);
          
          // Agregar marcador de usuario
          if (window.userMarker) {
            map.removeLayer(window.userMarker);
          }
          
          window.userMarker = L.marker([userLocation.lat, userLocation.lng], {
            icon: L.divIcon({
              html: `<div style="background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); animation: pulse 2s infinite;">👤</div>`,
              className: 'user-marker',
              iconSize: [24, 24],
              iconAnchor: [12, 12]
            })
          }).addTo(map).bindPopup('📍 Tu ubicación');
          
          map.setView([userLocation.lat, userLocation.lng], 10);
        },
        (error) => {
          removerNotificacionMapa(loadingNotification);
          let mensaje = 'Error de ubicación';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              mensaje = 'Permiso denegado. Haz clic en el mapa.';
              break;
            case error.POSITION_UNAVAILABLE:
              mensaje = 'Ubicación no disponible.';
              break;
            case error.TIMEOUT:
              mensaje = 'Tiempo agotado.';
              break;
          }
          mostrarNotificacionMapa('error', mensaje);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    }

    function onMapClick(e) {
      userLocation = { lat: e.latlng.lat, lng: e.latlng.lng };
      
      if (window.userMarker) {
        map.removeLayer(window.userMarker);
      }
      
      window.userMarker = L.marker([userLocation.lat, userLocation.lng], {
        icon: L.divIcon({
          html: `<div style="background: #f59e0b; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">🎯</div>`,
          className: 'search-marker',
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        })
      }).addTo(map).bindPopup('🎯 Punto seleccionado');
      
      mostrarNotificacionMapa('success', 'Punto seleccionado', 1500);
    }

    function fitAllMarkers() {
      if (filteredPoblados.length === 0) {
        mostrarNotificacionMapa('error', 'No hay poblados para mostrar');
        return;
      }
      
      // Obtener todos los marcadores visibles del cluster
      const allMarkers = [];
      markersCluster.eachLayer(layer => {
        if (layer.getLatLng) {
          allMarkers.push(layer);
        }
      });
      
      if (allMarkers.length > 0) {
        const group = new L.featureGroup(allMarkers);
        if (group.getBounds().isValid()) {
          map.fitBounds(group.getBounds(), { 
            padding: [20, 20],
            maxZoom: 12 // Evitar zoom excesivo
          });
          mostrarNotificacionMapa('success', 'Vista ajustada a todos los poblados', 2000);
        }
      } else {
        // Fallback: usar coordenadas de los datos
        const bounds = L.latLngBounds();
        filteredPoblados.forEach(poblado => {
          const geom = poblado.geom_geojson || poblado.geom;
          if (geom && geom.coordinates) {
            const [lng, lat] = geom.coordinates;
            bounds.extend([lat, lng]);
          }
        });
        
        if (bounds.isValid()) {
          map.fitBounds(bounds, { 
            padding: [20, 20],
            maxZoom: 12
          });
          mostrarNotificacionMapa('success', 'Vista ajustada', 2000);
        }
      }
    }

    function llenarFiltrosFallback() {
      const provinciaSelect = document.getElementById('provinciaFilter');
      const tipoSelect = document.getElementById('tipoFilter');
      
      if (provinciaSelect.children.length === 1 && poblados.length > 0) {
        const provincias = [...new Set(poblados.map(p => p.provincia).filter(Boolean))].sort();
        provinciaSelect.innerHTML = '<option value="">Todas las provincias</option>' +
          provincias.map(p => `<option value="${p}">${p}</option>`).join('');
      }
      
      if (tipoSelect.children.length === 1 && poblados.length > 0) {
        const tipos = [...new Set(poblados.map(p => p.tipo).filter(Boolean))].sort();
        tipoSelect.innerHTML = '<option value="">Todos los tipos</option>' +
          tipos.map(t => `<option value="${t}">${t}</option>`).join('');
      }
    }

    function configurarEventos() {
      // Búsqueda con debounce optimizado
      document.getElementById('searchInput').addEventListener('input', 
        debounce(() => {
          if (currentMode !== 'radius') {
            aplicarFiltros();
          }
        }, 750) // Aumentamos el debounce para mejor performance
      );
      
      // Eventos de filtros
      ['provinciaFilter', 'tipoFilter'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
          if (window.radiusCircle) {
            map.removeLayer(window.radiusCircle);
            window.radiusCircle = null;
          }
          if (currentMode === 'radius') {
            currentMode = 'filtered';
          }
        });
      });

      // Teclas de acceso rápido
      document.getElementById('radiusInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') buscarCercanos();
      });

      document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') aplicarFiltros();
      });
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Nueva función para notificaciones en el mapa
    function mostrarNotificacionMapa(tipo, mensaje, duracion = 3000) {
      const container = document.getElementById('mapNotifications');
      
      const iconos = {
        loading: '⏳',
        success: '✅',
        error: '❌',
        info: 'ℹ️'
      };
      
      const notification = document.createElement('div');
      notification.className = `map-notification ${tipo}`;
      notification.innerHTML = `${iconos[tipo]} ${mensaje}`;
      
      container.appendChild(notification);
      
      // Auto-remover después del tiempo especificado (incluso para loading si no se remueve manualmente)
      const autoRemoveTimer = setTimeout(() => {
        if (notification.parentNode) {
          notification.classList.add('removing');
          setTimeout(() => {
            if (notification.parentNode) {
              container.removeChild(notification);
            }
          }, 200);
        }
      }, tipo === 'loading' ? 10000 : duracion); // Loading se auto-elimina después de 10 segundos como fallback
      
      // Guardar referencia del timer para poder cancelarlo
      notification.autoRemoveTimer = autoRemoveTimer;
      
      // Limitar el número de notificaciones visibles
      const notifications = container.querySelectorAll('.map-notification');
      if (notifications.length > 3) {
        const oldest = notifications[0];
        oldest.classList.add('removing');
        if (oldest.autoRemoveTimer) {
          clearTimeout(oldest.autoRemoveTimer);
        }
        setTimeout(() => {
          if (oldest.parentNode) {
            container.removeChild(oldest);
          }
        }, 200);
      }
      
      return notification;
    }

    // Función para remover notificación específica
    function removerNotificacionMapa(notification) {
      if (notification && notification.parentNode) {
        // Cancelar el timer automático
        if (notification.autoRemoveTimer) {
          clearTimeout(notification.autoRemoveTimer);
        }
        
        notification.classList.add('removing');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 200);
      }
    }

    function actualizarEstadisticas() {
      const total = poblados.length;
      const visible = filteredPoblados.length;
      
      document.getElementById('totalCount').textContent = total.toLocaleString();
      document.getElementById('visibleCount').textContent = visible.toLocaleString();
      document.getElementById('headerVisible').textContent = visible.toLocaleString();
      
      // Animación sutil de conteo
      animateNumber('headerTotal', total);
    }

    function animateNumber(elementId, targetValue) {
      const element = document.getElementById(elementId);
      const currentValue = parseInt(element.textContent.replace(/,/g, '')) || 0;
      
      if (currentValue === targetValue) return;
      
      const increment = targetValue > currentValue ? 1 : -1;
      const step = Math.abs(targetValue - currentValue) / 15; // Más rápido
      
      let current = currentValue;
      const timer = setInterval(() => {
        current += increment * Math.max(1, Math.floor(step));
        
        if ((increment > 0 && current >= targetValue) || (increment < 0 && current <= targetValue)) {
          current = targetValue;
          clearInterval(timer);
        }
        
        element.textContent = current.toLocaleString();
      }, 30); // Más fluido
    }

    // Agregar estilos de animación
    const style = document.createElement('style');
    style.textContent = `
      @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
      }
      
      .custom-popup .leaflet-popup-content-wrapper {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: none;
      }
      
      .custom-popup .leaflet-popup-tip {
        background: white;
      }
      
      /* Optimizaciones visuales */
      .leaflet-cluster-anim .leaflet-marker-icon, .leaflet-cluster-anim .leaflet-marker-shadow {
        transition: transform 0.15s ease-out, opacity 0.15s ease-in;
      }
    `;
    document.head.appendChild(style);
  </script>

</body>
</html>
