<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Geovisor de Poblados</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 0; 
      padding: 0; 
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .controls {
      background: white;
      padding: 1rem;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    select, input {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #5a6fd8;
    }
    
    .main-content {
      flex: 1;
      display: flex;
      min-height: 0;
    }
    
    #map {
      flex: 1;
      min-height: 400px;
    }
    
    .sidebar {
      width: 350px;
      background: #f8f9fa;
      border-left: 1px solid #e0e0e0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-header {
      padding: 1rem;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      font-weight: 600;
    }
    
    .stats {
      padding: 1rem;
      background: white;
      margin-bottom: 1rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .stat-item {
      text-align: center;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .stat-number {
      font-size: 1.5rem;
      font-weight: 600;
      color: #667eea;
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.25rem;
    }
    
    .poblado-list {
      flex: 1;
      padding: 0;
    }
    
    .poblado-item {
      padding: 1rem;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .poblado-item:hover {
      background: #e3f2fd;
    }
    
    .poblado-item.selected {
      background: #bbdefb;
      border-left: 4px solid #667eea;
    }
    
    .poblado-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.25rem;
    }
    
    .poblado-info {
      font-size: 0.85rem;
      color: #666;
      line-height: 1.4;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }
    
    .status {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }
    
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.loading { background: #d1ecf1; color: #0c5460; }

    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: 300px;
      }
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>üó∫Ô∏è Geovisor de Poblados</h1>
  </div>

  <div class="controls">
    <div class="control-group">
      <label>Provincia:</label>
      <select id="provinciaFilter">
        <option value="">Todas las provincias</option>
      </select>
    </div>
    
    <div class="control-group">
      <label>Tipo:</label>
      <select id="tipoFilter">
        <option value="">Todos los tipos</option>
      </select>
    </div>
    
    <div class="control-group">
      <label>Buscar:</label>
      <input type="text" id="searchInput" placeholder="Nombre del poblado..." />
    </div>
    
    <button onclick="aplicarFiltros()">Aplicar Filtros</button>
    <button onclick="limpiarFiltros()">Limpiar</button>
  </div>

  <div id="status"></div>

  <div class="main-content">
    <div id="map"></div>
    
    <div class="sidebar">
      <div class="sidebar-header">
        <div>Poblados Encontrados</div>
      </div>
      
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="totalCount">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="visibleCount">0</div>
          <div class="stat-label">Visibles</div>
        </div>
      </div>
      
      <div class="poblado-list" id="pobladoList">
        <div class="loading">Cargando poblados...</div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Configuraci√≥n de Supabase
    const SUPABASE_URL = 'https://sbkmybydshshxoiiimve.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNia215Ynlkc2hzaHhvaWlpbXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyOTMwODIsImV4cCI6MjA2NTg2OTA4Mn0.ZsXSKy3pYGA9AA9oXJLzPkdEhryieF-5Z3XSREueEfc';

    // Variables globales
    let map;
    let markersLayer;
    let poblados = [];
    let filteredPoblados = [];
    let selectedPoblado = null;

    // Inicializar la aplicaci√≥n
    window.addEventListener('DOMContentLoaded', async () => {
      initMap();
      await cargarDatosIniciales();
      configurarFiltros();
    });

    function initMap() {
      // Centrar en Ecuador
      map = L.map('map').setView([-1.8312, -78.1834], 6);
      
      // Agregar capa base
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
      
      // Crear grupo de marcadores
      markersLayer = L.layerGroup().addTo(map);
    }

    async function cargarDatosIniciales() {
      await Promise.all([
        cargarPoblados(),
        cargarProvincias(),
        cargarTipos()
      ]);
    }

    async function cargarPoblados() {
      const status = document.getElementById('status');
      status.className = 'status loading';
      status.textContent = 'üîÑ Cargando poblados desde Supabase...';

      try {
        console.log('Llamando a get_all_poblados...');
        
        const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_all_poblados`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Error response:', errorText);
          throw new Error(`Error ${response.status}: ${response.statusText} - ${errorText}`);
        }

        poblados = await response.json();
        console.log('Poblados cargados:', poblados.length);
        
        filteredPoblados = [...poblados];
        
        status.className = 'status success';
        status.textContent = `‚úÖ ${poblados.length} poblados cargados correctamente`;
        
        mostrarPobladosEnMapa();
        actualizarListaPoblados();
        actualizarEstadisticas();
        
      } catch (error) {
        console.error('Error completo:', error);
        status.className = 'status error';
        status.textContent = `‚ùå Error al cargar poblados: ${error.message}`;
        
        // Fallback: intentar con consulta REST directa
        console.log('Intentando fallback con REST directo...');
        await cargarPobladosFallback();
      }
    }

    async function cargarPobladosFallback() {
      const status = document.getElementById('status');
      status.className = 'status loading';
      status.textContent = 'üîÑ Intentando carga alternativa...';

      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/poblados?select=*`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });

        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        
        // Convertir los datos al formato esperado
        poblados = data.map(poblado => ({
          ...poblado,
          geom_geojson: poblado.geom // REST devuelve geom directamente
        }));
        
        filteredPoblados = [...poblados];
        
        status.className = 'status success';
        status.textContent = `‚úÖ ${poblados.length} poblados cargados (modo compatibilidad)`;
        
        mostrarPobladosEnMapa();
        actualizarListaPoblados();
        actualizarEstadisticas();
        
      } catch (error) {
        status.className = 'status error';
        status.textContent = `‚ùå Error en carga alternativa: ${error.message}`;
        console.error('Error en fallback:', error);
      }
    }

    async function cargarProvincias() {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_unique_provincias`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const provincias = await response.json();
          const select = document.getElementById('provinciaFilter');
          select.innerHTML = '<option value="">Todas las provincias</option>' +
            provincias.map(p => `<option value="${p.provincia}">${p.provincia}</option>`).join('');
        } else {
          // Fallback: extraer provincias de los datos cargados
          console.log('Usando fallback para provincias');
        }
      } catch (error) {
        console.error('Error cargando provincias:', error);
        // Se llenar√° con el fallback m√°s tarde
      }
    }

    async function cargarTipos() {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_unique_tipos`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const tipos = await response.json();
          const select = document.getElementById('tipoFilter');
          select.innerHTML = '<option value="">Todos los tipos</option>' +
            tipos.map(t => `<option value="${t.tipo}">${t.tipo}</option>`).join('');
        } else {
          // Fallback: extraer tipos de los datos cargados
          console.log('Usando fallback para tipos');
        }
      } catch (error) {
        console.error('Error cargando tipos:', error);
        // Se llenar√° con el fallback m√°s tarde
      }
    }

    function mostrarPobladosEnMapa() {
      markersLayer.clearLayers();
      
      filteredPoblados.forEach(poblado => {
        // Manejar tanto geom_geojson (RPC) como geom (REST directo)
        const geom = poblado.geom_geojson || poblado.geom;
        
        if (geom && geom.coordinates) {
          const [lng, lat] = geom.coordinates;
          
          // Crear icono personalizado seg√∫n el tipo
          const icon = L.divIcon({
            html: getIconForType(poblado.tipo),
            className: 'custom-marker',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          });
          
          const marker = L.marker([lat, lng], { icon })
            .bindPopup(createPopupContent(poblado))
            .addTo(markersLayer);
            
          marker.poblado = poblado;
          marker.on('click', () => selectPoblado(poblado));
        }
      });

      // Si no se cargaron filtros por RPC, llenarlos ahora
      if (poblados.length > 0) {
        llenarFiltrosFallback();
      }
    }

    function llenarFiltrosFallback() {
      // Solo llenar si los selects est√°n vac√≠os (RPC fall√≥)
      const provinciaSelect = document.getElementById('provinciaFilter');
      const tipoSelect = document.getElementById('tipoFilter');
      
      if (provinciaSelect.children.length === 1) {
        const provincias = [...new Set(poblados.map(p => p.provincia).filter(Boolean))].sort();
        provinciaSelect.innerHTML = '<option value="">Todas las provincias</option>' +
          provincias.map(p => `<option value="${p}">${p}</option>`).join('');
      }
      
      if (tipoSelect.children.length === 1) {
        const tipos = [...new Set(poblados.map(p => p.tipo).filter(Boolean))].sort();
        tipoSelect.innerHTML = '<option value="">Todos los tipos</option>' +
          tipos.map(t => `<option value="${t}">${t}</option>`).join('');
      }
    }

    function getIconForType(tipo) {
      const icons = {
        'ciudad': 'üèôÔ∏è',
        'pueblo': 'üèòÔ∏è',
        'villa': 'üè°',
        'aldea': 'üè†',
        'default': 'üìç'
      };
      return icons[tipo?.toLowerCase()] || icons.default;
    }

    function createPopupContent(poblado) {
      return `
        <div style="min-width: 200px;">
          <h3 style="margin: 0 0 10px 0; color: #333;">${poblado.nombre}</h3>
          <p style="margin: 5px 0;"><strong>C√≥digo:</strong> ${poblado.f_code || 'N/A'}</p>
          <p style="margin: 5px 0;"><strong>Provincia:</strong> ${poblado.provincia || 'N/A'}</p>
          <p style="margin: 5px 0;"><strong>Tipo:</strong> ${poblado.tipo || 'N/A'}</p>
          <p style="margin: 5px 0;"><strong>SOC:</strong> ${poblado.soc || 'N/A'}</p>
        </div>
      `;
    }

    function actualizarListaPoblados() {
      const lista = document.getElementById('pobladoList');
      
      if (filteredPoblados.length === 0) {
        lista.innerHTML = '<div class="loading">No se encontraron poblados con los filtros aplicados</div>';
        return;
      }
      
      lista.innerHTML = filteredPoblados.map(poblado => `
        <div class="poblado-item" onclick="selectPoblado(${JSON.stringify(poblado).replace(/"/g, '&quot;')})">
          <div class="poblado-name">${poblado.nombre}</div>
          <div class="poblado-info">
            <div>${poblado.provincia} ‚Ä¢ ${poblado.tipo}</div>
            <div>C√≥digo: ${poblado.f_code || 'N/A'}</div>
          </div>
        </div>
      `).join('');
    }

    function selectPoblado(poblado) {
      selectedPoblado = poblado;
      
      // Actualizar selecci√≥n visual en la lista
      document.querySelectorAll('.poblado-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      const selectedItem = Array.from(document.querySelectorAll('.poblado-item'))
        .find(item => item.textContent.includes(poblado.nombre));
      if (selectedItem) {
        selectedItem.classList.add('selected');
      }
      
      // Centrar mapa en el poblado seleccionado
      const geom = poblado.geom_geojson || poblado.geom;
      if (geom && geom.coordinates) {
        const [lng, lat] = geom.coordinates;
        map.setView([lat, lng], 12);
      }
    }

    function configurarFiltros() {
      document.getElementById('searchInput').addEventListener('input', aplicarFiltros);
    }

    async function aplicarFiltros() {
      const provinciaFiltro = document.getElementById('provinciaFilter').value;
      const tipoFiltro = document.getElementById('tipoFilter').value;
      const busqueda = document.getElementById('searchInput').value.toLowerCase();

      // Si no hay filtros, mostrar todos
      if (!provinciaFiltro && !tipoFiltro && !busqueda) {
        filteredPoblados = [...poblados];
      } else {
        // Intentar usar RPC primero, fallback a filtrado local
        try {
          const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/search_poblados_advanced`, {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              search_name: busqueda || null,
              filter_provincia: provinciaFiltro || null,
              filter_tipo: tipoFiltro || null
            })
          });

          if (response.ok) {
            filteredPoblados = await response.json();
          } else {
            throw new Error('RPC failed');
          }
        } catch (error) {
          console.log('Usando filtrado local:', error.message);
          // Fallback: filtrado local
          filteredPoblados = poblados.filter(poblado => {
            const matchProvincia = !provinciaFiltro || poblado.provincia === provinciaFiltro;
            const matchTipo = !tipoFiltro || poblado.tipo === tipoFiltro;
            const matchBusqueda = !busqueda || poblado.nombre.toLowerCase().includes(busqueda);
            
            return matchProvincia && matchTipo && matchBusqueda;
          });
        }
      }
      
      mostrarPobladosEnMapa();
      actualizarListaPoblados();
      actualizarEstadisticas();
    }

    function limpiarFiltros() {
      document.getElementById('provinciaFilter').value = '';
      document.getElementById('tipoFilter').value = '';
      document.getElementById('searchInput').value = '';
      aplicarFiltros();
    }

    function actualizarEstadisticas() {
      document.getElementById('totalCount').textContent = poblados.length;
      document.getElementById('visibleCount').textContent = filteredPoblados.length;
    }
  </script>

</body>
</html>
